name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: 192.168.1.27
          username: tholib_server
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          timeout: 120s
          script_stop: true
          script: |
            set -e
            cd /var/www/esppd

            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main --quiet

            echo "ğŸ“¦ Installing dependencies..."
            composer install --no-dev --optimize-autoloader --quiet 2>&1 | tail -3

            echo "ğŸ—„ï¸  Running migrations..."
            php artisan migrate --force --quiet

            echo "âš™ï¸  Caching configuration..."
            php artisan config:cache --quiet
            php artisan route:cache --quiet
            php artisan view:cache --quiet

            echo "âš¡ Optimizing..."
            php artisan optimize --quiet

            echo "ğŸ§¹ Clearing caches..."
            php artisan cache:clear --quiet

            echo "âœ… Deployment complete!"
            echo "Application: https://esppd.infiatin.cloud"

      - name: ğŸ“§ Notify Deployment Success
        if: success()
        run: |
          echo "âœ… Deployment successful to https://esppd.infiatin.cloud"

      - name: ğŸš¨ Notify Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check logs for details."
