name: Branch protection (manual)

on:
  workflow_dispatch:

jobs:
  protect-main:
    runs-on: ubuntu-latest
    steps:
      - name: Check inputs
        run: |
          if [ -z "${{ secrets.ADMIN_TOKEN }}" ]; then echo "ADMIN_TOKEN secret is required to run this workflow" && exit 1; fi
      - name: Set branch protection for main
        env:
          GITHUB_TOKEN: ${{ secrets.ADMIN_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          API="https://api.github.com/repos/$REPO/branches/main/protection"
          echo "Setting branch protection for $REPO main"
          curl -s -X PUT "$API" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{
              "required_status_checks": {"strict": true, "contexts": ["Full repository checks", "CI", "CodeQL analysis", "Secret scan (gitleaks - repo history)"]},
              "enforce_admins": true,
              "required_pull_request_reviews": {"required_approving_review_count": 1, "dismiss_stale_reviews": true, "require_code_owner_reviews": true},
              "required_linear_history": {"enabled": true},
              "allow_force_pushes": false,
              "restrictions": null
            }' | jq .
      - name: Success
        run: echo "Branch protection request sent. Verify settings in repo settings."
